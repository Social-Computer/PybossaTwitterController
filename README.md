# TwitterCrowdSourcingController
A middleware for ad-hoc real-time crowdsourcing via social media. Bridges between the APIs of popular social media services (Twitter and Facebook to begin with). https://social-computer.github.io

There are three main components of TwitterCrowdSourcingController: Project - Task and TaskRun that are modelled within the database.

##Get Started

Add your config to the file "configExample.properties"
Rename the file to "config.properties" then move it to src/main/resources
Then run the following commands

```
mvn clean package
sh RunAllProcesses.sh # to run all processes
sh stopAllProcesses.sh # to stop all processes
```

## logging
Loggging is done with log4j. For each process, go to script/{processname}. There are logging.log and nohub.out which contains the logging info.

## Documentation
This project have different processes that keep taking to eachother through the database.

The processes (all rest in the main package recoin.mongodb_version) are as follows:

1. ProjectCreator (Instantiate projects to be ready for further processing)
2. TaskCreator (instantiate projects' tasks for further processing)
3. TwitterTaskPerformer (push tasks to Twitter "task")
4. TwitterTaskCollector (pull contributions from Twitter "taskRun")
5. FacebookTaskPerformer (push tasks to Facebook "task")
6. FacebookTaskCollector (pull contributions from Facebook "taskRun")
7. InstructionSetPorcessor (perform actions based on taskRuns)
8. RestService (run the rest services)
9. Simulator (simulate contributions based on synthatic data that is produced from various sources)


### Input
For this project to work, there should be two MongoDB databases (these can be modified with the config file) which are: RECOIN\_bins and RECOIN\_projects. These should be instatiated by [RECOINObserver](https://github.com/project-recoin/RECOINObserver).


- RECOIN_projects: it contains all projects.

```
{
  "project_id": 4069159, //auto generated by the _id.
  "project_name": "zikavirus",
  "project_start_timestamp": "",
  "project_end_timestamp": "",
  "project_status": "empty", //determine the state of the project and accept {empty, ready, inserted, completed}
  "observed": "2016-05-19 17:44:54",
  "bin_id": "zikavirus",
  "identifiers": [
    "zikavirus"
  ],
  "project_type": "validate", //this field does not function at the moment
  "task_type": "validate" //this field does not function at the moment
}
```

Note that "project_status" : "empty" which will be kick started by the ProjectCreator later.

- RECOIN_bins: this database will have collections as bins. Each bin represents a proejct. Each bin have all raw tasks to be retrived by the TaskCreator later.

```
{
  "_source": "twitter",
  "id": "733316451554197504",
  "timestamp": "2016-05-19 15:20:41",
  "text": "Fighting the Zika virus with the power of supercomputing https:\/\/t.co\/GAwWUhFC2f #ZikaVirus",
  "screen_name": "robinsnewswire",
  "isRetweet": false,
  "urls": [
    "https:\/\/t.co\/GAwWUhFC2f"
  ],
  "mentions": [
    
  ],
  "hashtags": [
    "ZikaVirus"
  ],
  "geo": {
    
  },
  "status_raw": {
    "filter_level": "low",
    "retweeted": false,
    "in_reply_to_screen_name": null,
    "possibly_sensitive": false,
    "truncated": false,
    "lang": "en",
    "in_reply_to_status_id_str": null,
    "id": "733316451554197504",
    "in_reply_to_user_id_str": null,
    "timestamp_ms": "1463671241068",
    "in_reply_to_status_id": null,
    "created_at": "Thu May 19 15:20:41 +0000 2016",
    "favorite_count": 0,
    "place": null,
    "coordinates": null,
    "text": "Fighting the Zika virus with the power of supercomputing https:\/\/t.co\/GAwWUhFC2f #ZikaVirus",
    "contributors": null,
    "geo": null,
    "entities": {
      "symbols": [
        
      ],
      "urls": [
        {
          "expanded_url": "https:\/\/www.sciencedaily.com\/releases\/2016\/05\/160519081841.htm",
          "indices": [
            57,
            80
          ],
          "display_url": "sciencedaily.com\/releases\/2016\/\u2026",
          "url": "https:\/\/t.co\/GAwWUhFC2f"
        }
      ],
      "hashtags": [
        {
          "text": "ZikaVirus",
          "indices": [
            81,
            91
          ]
        }
      ],
      "user_mentions": [
        
      ]
    },
    "is_quote_status": false,
    "source": "<a href=\"http:\/\/ifttt.com\" rel=\"nofollow\">IFTTT<\/a>",
    "favorited": false,
    "in_reply_to_user_id": null,
    "retweet_count": 0,
    "id_str": "733316451554197504",
    "user": {
      "location": "Flying The Web For News",
      "default_profile": false,
      "profile_background_tile": true,
      "statuses_count": 976794,
      "lang": "en",
      "profile_link_color": "880000",
      "id": 40173650,
      "following": null,
      "protected": false,
      "favourites_count": 589,
      "profile_text_color": "634047",
      "verified": false,
      "description": "Providing trusted world news reports and shopping discounts on the web 24\/7. Retweeting for opinions, useful information, and the many voices of Twitter.",
      "contributors_enabled": false,
      "profile_sidebar_border_color": "FFFFFF",
      "name": "World News Report",
      "profile_background_color": "141106",
      "created_at": "Fri May 15 04:16:20 +0000 2009",
      "default_profile_image": false,
      "followers_count": 23279,
      "profile_image_url_https": "https:\/\/pbs.twimg.com\/profile_images\/2240371734\/robin_digital_stamp_colored_icon2_normal.png",
      "geo_enabled": true,
      "profile_background_image_url": "http:\/\/pbs.twimg.com\/profile_background_images\/13240545\/microsoftocean1.jpg",
      "profile_background_image_url_https": "https:\/\/pbs.twimg.com\/profile_background_images\/13240545\/microsoftocean1.jpg",
      "follow_request_sent": null,
      "url": "http:\/\/www.robinspost.com",
      "utc_offset": -25200,
      "time_zone": "Pacific Time (US & Canada)",
      "notifications": null,
      "profile_use_background_image": true,
      "friends_count": 18960,
      "profile_sidebar_fill_color": "FFFFFF",
      "screen_name": "robinsnewswire",
      "id_str": "40173650",
      "profile_image_url": "http:\/\/pbs.twimg.com\/profile_images\/2240371734\/robin_digital_stamp_colored_icon2_normal.png",
      "listed_count": 3256,
      "is_translator": false
    }
  },
  "media_url": "",
  "wasProcessed": true //this field is added and modifid by this project and not by the Observer. It determines whether the bin is added to tasks or not. if yes, get another bin.
}
```


Once these two database have some inputs, this project can be run.


### ProjectCreator
keep watching the "RECOIN\_projects" for any empty projects to be instantiated while maintaining the limit of active project that can be set by the config file. This process keep looping based on a time that can be set from the config file. The same loop logic is done for all processes. Any modified project will be set to "project_status" : "ready" instead of "empty".



### TaskCreator
For any "ready" project, retreive a number of tasks from "bins" in the database "RECOIN\_bins" based on a limit set by the config file to be added to a new collection named "tasks" within database "RECOIN\_projects".


```
{
  "publishedAt": "2016-06-17 14:47:30",
  "project_id": 4069159, 
  "bin_id_String": "573dfb96e4b0595c813e1775",
  "task_status": "ready",
  "twitter_task_status": "ready",
  "facebook_task_status": "ready",
  "task_text": "#ZikaVirus will hit southern GOP states hard. I agree with @marcorubio  https:\/\/t.co\/xX2GiRrRJS",
  "twitter_url": "https:\/\/twitter.com\/bikka\/status\/733342097055449089",
  "task_type": "validate",
  "priority": 0, // will take effect witin the queue
  "pushing_times": 0, // to determines when to move to zombie state based on config file
  "embed": { // for the purpose of displaying a tweet widget instead of get requesting it each time (performance optmisation).
    "author_name": "bikka",
    "author_url": "https:\/\/twitter.com\/bikka",
    "cache_age": "3153600000",
    "width": 550,
    "html": "<blockquote class=\"twitter-tweet\"><p lang=\"en\" dir=\"ltr\"><a href=\"https:\/\/twitter.com\/hashtag\/ZikaVirus?src=hash\">#ZikaVirus<\/a> will hit southern GOP states hard. I agree with <a href=\"https:\/\/twitter.com\/marcorubio\">@marcorubio<\/a>  <a href=\"https:\/\/t.co\/xX2GiRrRJS\">https:\/\/t.co\/xX2GiRrRJS<\/a><\/p>&mdash; bikka (@bikka) <a href=\"https:\/\/twitter.com\/bikka\/status\/733342097055449089\">May 19, 2016<\/a><\/blockquote>\n<script async src=\"\/\/platform.twitter.com\/widgets.js\" charset=\"utf-8\"><\/script>",
    "provider_url": "https:\/\/twitter.com",
    "type": "rich",
    "provider_name": "Twitter",
    "version": "1.0",
    "url": "https:\/\/twitter.com\/bikka\/status\/733342097055449089",
    "height": null
  },
  "embed_nomedia": {
    "author_name": "bikka",
    "author_url": "https:\/\/twitter.com\/bikka",
    "cache_age": "3153600000",
    "width": 550,
    "html": "<blockquote class=\"twitter-tweet\" data-cards=\"hidden\"><p lang=\"en\" dir=\"ltr\"><a href=\"https:\/\/twitter.com\/hashtag\/ZikaVirus?src=hash\">#ZikaVirus<\/a> will hit southern GOP states hard. I agree with <a href=\"https:\/\/twitter.com\/marcorubio\">@marcorubio<\/a>  <a href=\"https:\/\/t.co\/xX2GiRrRJS\">https:\/\/t.co\/xX2GiRrRJS<\/a><\/p>&mdash; bikka (@bikka) <a href=\"https:\/\/twitter.com\/bikka\/status\/733342097055449089\">May 19, 2016<\/a><\/blockquote>\n<script async src=\"\/\/platform.twitter.com\/widgets.js\" charset=\"utf-8\"><\/script>",
    "provider_url": "https:\/\/twitter.com",
    "type": "rich",
    "provider_name": "Twitter",
    "version": "1.0",
    "url": "https:\/\/twitter.com\/bikka\/status\/733342097055449089",
    "height": null
  },
  "task_id": 1423977, //auto generated by the _id.
  "twitter_lastPushAt": "2016-06-19 21:28:56", // to be used for rebusing tweets based on the config file
  "facebook_lastPushAt": "2016-06-18 23:06:28",
  "facebook_task_id": "964602923577144_1024330604271042"
}
```

Note that "task\_status" : "ready", "twitter\_task\_status" : "ready" and "facebook\_task\_status" : "ready".


### Twitter/FacebookPerformer
The process is resposible for pusing tasks to their specific platforms (Twitter/Facebook). Given a "TasksPerProject" proprty within config file, perfrom a proiorty queue to push tasks.


#### Queue
Everytime Twitter/FacebookPerformer started the loop, it builds a queue to determine which tasks to be pushed first. The priorty strategy we use is based on:

1. "priority" of each task (see json),
2. twitter_task_status and finally
3. legth of the "task_text". 

For any new project "priority" defualt value is zero. But as tasks are being pushed and gets contributions, it is possbile for contributor to rank tasks by voting them up or down. This will then affect the coming repushing of tasks as their "priority" would be modified.


Once the queue is being contructed for the run, we employ a "stream strategy".

#### Streaming Strategy
Pushing tasks out the queue is dynamiclly set. The more contribtions the system receive, the more tasks are being pushed to that platfrom and vise versa. The is also done by having a top and bottom limit speed set by the config file "firstLimit" which is the initial speed, "topSpeed" and "lowestSpeed".


#### Tasks Repushing
Twitter/FacebookPerformer also perform repushing of tasks based on "RePushTaskToTwitter" propery from the config file. When each push/repush, "pushing_times" is increased by one. There is a limit for the number of pushes set by "pushinglimit" from config file.


#### Zombie State
This is a state where a task is no longer to be pushed based on different measures.

* if a task reaches the "pushinglimit", set by config file.
* if the tweet is no longer available (i.e., was deleted by the poster of the tweet).
* if a task reaches a number of contribtions. //to be added.
* if task is marked as completed "task\_status" : "completed". This can be done through adding an instruction set.


### Twitter/FacebookCollector
The process is resposible for retriving contributions (taskRus) from diffrernt platforms. Contribtuons are being replies/comments as of Twitter/Facebook respectively. 


### InstructionSetPorcessor
When submitting contributions to the system by any means (Twitter/Facebook/Google extention or RestService), these contributions have to follow a specific structure, we call it "Instruction set". Different sets serve different purposes and there are sometimes specific actions that are carried out based on them.

* PRIO [+1|-1] Prioritize a task
* SHARE [userid1,userid2,...,useridN] Pass a task to users.
* ENRICH [your message, hashtags or URIs] Enrich a task with some resources.
* TRANS [your translation of original content] Translate a task with a different langauge. This is also can be seen as a special kind of ENRICH.
* RESOLVE [your message to resolve this message] resolve a task to be go to a zombie state.

Also see some examples from [here](https://social-computer.github.io).

To simplify the process, we also propose two other platfroms which provides an easy interface for users to be able to add contribtuins. These are being Google extension and a web page.

### RestService
In addition to Twitter/FacebookCollector, we also provide rest apis that exposes various information about the system in Json format. These can both read and submit contributions. We also provide a web page that is built on top of this RestService.


RestService is built using [Spark Framework](http://sparkjava.com). Port and domain is set by config file with "restPort" and "domainURI".

```
http://domain.org/RecoinRestController/Project
http://domain.org/RecoinRestController/Project/{id}
http://domain.org/RecoinRestController/Task
http://domain.org/RecoinRestController/Task/project?project_id={id}
http://domain.org/RecoinRestController/Task/{id}
http://domain.org/RecoinRestController/Task/{id}/Responses
http://domain.org/RecoinRestController/TaskRun
http://domain.org/RecoinRestController/TaskRun/project?project_id={id}
http://domain.org/RecoinRestController/TaskRun/{id}
http://domain.org/RecoinRestController/TaskRun/task?task_id={id}
http://domain.org/RecoinRestController/getTasks //Give top tasks with no contributions. This is used for the google extension
http://domain.org/RecoinRestController/sendTaskRun?text=text&task_id={id}&project_id={id}&contributor_name={name}&source={TaskView/googleExtension}
```

All rest apis produce json format. They all have a defualt limit of 200 records. There is also  pagination implemented as in:

```
http://domain.org/RecoinRestController/Project?limit={limit}&offset={offset} 
```
There is a field "offset" that is generated within each json request to indicate whether you need to make another request with the given "offset" field value. A value of zero indicates that the complete list is retrieved. A response with 200 indicates a successful operation. 500 code for any general errors (internal or within the rest api). 400 code for duplicate insertion. If there are no records matching the request, response will be {"message":""}.



### Web page
There is also a web page that is built on top of RestService which provides an easy way for users to interact with the various componenets of the system for either just browsing/stats or also to provide cocntrubtions. See [DefaultViewPHP](https://github.com/Social-Computer/DefaultViewPHP).


### Google Extension
This is also a google extention that from which users can submit their contributions. See [chromeCollect](https://github.com/project-recoin/chromeCollect).


### Simulator
This is a process that mimics users while providing contrubtions. These data are not completey sythatic, they are provided by different sources as follows:

* TRANS is provided by [yandex](https://tech.yandex.com/translate/?ncrnd=7859). It transate a task to a randomlly chosen langauge from { "en", "ar", "de", "es", "fr"}. This list can be extended.
* ENRICH is provided by [bing](http://www.bing.com/toolbox/bingsearchapi). It searches for the "task\_text" within this search engine, then chosing a randomlly of the top results to be added as an enrichment.
* PRIO is randommly set to either 1 or -1
* SHARE is set by a text file that has a number of accounts to have different tasks shared with these accounts.


#Acknowledgements
This work is supported by the Lloyd's Register Foundation under the RECOIN project grant.
